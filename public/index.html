<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRSQUWK Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header style="text-align: center; margin-bottom: 20px;">
        <img src="/media/airsquak.jpg" alt="AirSquawk Logo" style="max-width: 300px; height: auto;">
        <h1>AirSquawk</h1>
        <div id="airline-db-indicator" style="color:#e0e0e0;margin-top:6px;font-size:12px;">Airline DB: <em>loading‚Ä¶</em></div>
    </header>
    
    <div id="connection-status" class="status-disconnected">‚óè Disconnected</div>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab('live', event)">Live</button>
        <button class="tab-button" onclick="showTab('airlines', event)">Airlines</button>
        <button class="tab-button" onclick="showTab('flights', event)">Flights</button>
        <button class="tab-button" onclick="showTab('positions', event)">Positions</button>
        <button class="tab-button" onclick="showTab('squawk', event)">Squawk</button>
        <button class="tab-button" onclick="showTab('heatmap', event)">Heatmap</button>
        <button class="tab-button" onclick="showTab('reception', event)">Reception</button>
        <button class="tab-button" onclick="showTab('cache', event)">Cache Status</button>
    </div>
    <div id="global-time-controls" style="margin:12px 0;">
        <div id="positions-buttons" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
            <button class="positions-window-btn" data-hours="1" onclick="handleGlobalTimeSelection(1)" title="Show last 1 hour" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">1h</button>
            <button class="positions-window-btn" data-hours="4" onclick="handleGlobalTimeSelection(4)" title="Show last 4 hours" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">4h</button>
            <button class="positions-window-btn" data-hours="6" onclick="handleGlobalTimeSelection(6)" title="Show last 6 hours" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">6h</button>
            <button class="positions-window-btn" data-hours="8" onclick="handleGlobalTimeSelection(8)" title="Show last 8 hours" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">8h</button>
            <button class="positions-window-btn" data-hours="12" onclick="handleGlobalTimeSelection(12)" title="Show last 12 hours" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">12h</button>
            <button class="positions-window-btn" data-hours="24" onclick="handleGlobalTimeSelection(24)" title="Show last 24 hours" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">24h</button>
            <button class="positions-window-btn" data-hours="168" onclick="handleGlobalTimeSelection(168)" title="Show last 1 week" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">1w</button>
            <button class="positions-window-btn" data-hours="672" onclick="handleGlobalTimeSelection(672)" title="Show last 4 weeks" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">4w</button>
            <button class="positions-window-btn" data-hours="all" onclick="handleGlobalTimeSelection(null)" title="Show all time" aria-pressed="false" tabindex="0" style="padding: 5px 10px;">All</button>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
            <label for="time-window" style="color:#e0e0e0;font-weight:600;">Time Window:</label>
            <select id="time-window" aria-label="Time Window" title="Select a time window for charts and positions" style="background:#141414;color:#e0e0e0;border:1px solid #333;border-radius:4px;padding:6px;">
                <option value="1h">1 Hour</option>
                <option value="4h">4 Hours</option>
                <option value="6h">6 Hours</option>
                <option value="8h">8 Hours</option>
                <option value="12h">12 Hours</option>
                <option value="24h" selected>24 Hours</option>
                <option value="1w">1 Week</option>
                <option value="4w">4 Weeks</option>
                <option value="all">All time</option>
            </select>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <label for="positions-start-time" style="font-weight: bold; color: #e0e0e0;">Start:</label>
            <input type="datetime-local" id="positions-start-time" style="padding: 5px; margin-right: 15px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
            <label for="positions-end-time" style="font-weight: bold; color: #e0e0e0;">End:</label>
            <input type="datetime-local" id="positions-end-time" style="padding: 5px; margin-right: 15px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
            
        </div>
    </div>
    <!--
    TAB INVENTORY:
    1. live-tab: Live aircraft tracking with real-time position updates
    2. airlines-tab: Airline statistics and flight data analysis
    3. flights-tab: Flight tracking and historical flight data
    4. positions-tab: Position statistics and time-series analysis
    5. squawk-tab: Squawk code transition analysis
    6. heatmap-tab: Aircraft position heatmap viewer (links to Leaflet)
    7. reception-tab: Reception range analysis (bearing/altitude plots)
    8. cache-tab: Heatmap cache status and management
    -->
    <script>
    // Remove conflicting tab activation on DOMContentLoaded
    // Only rely on showTab for tab switching
    // window.addEventListener('DOMContentLoaded', function() {
    //     document.querySelectorAll('.tab-content').forEach(function(content, idx) {
    //         if (idx === 0) {
    //             content.classList.add('active');
    //         } else {
    //             content.classList.remove('active');
    //         }
    //     });
    // });
    // Instead, activate the first tab on load using showTab
    window.addEventListener('DOMContentLoaded', function() {
        showTab('live');
    });
    </script>

    <div id="reception-tab" class="tab-content">
        <h2>Reception Range</h2>
        <div id="reception-receiver-info" style="margin-bottom:15px;padding:10px;background:#1e1e1e;border-radius:4px;border:1px solid #333;color:#e0e0e0;"><strong style="color:#fff;">Receiver Position:</strong> <span id="receiver-coords" style="color:#42a5f5;">Loading...</span></div>
        <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <!-- Per-tab quick buttons removed: global time control is used instead -->
            <!-- Start/End now in global header -->
            <button class="auto-hidden-refresh" onclick="loadReceptionRange()" title="Refresh" style="padding: 6px 15px; background: #42a5f5; color: #fff; border: none; border-radius: 4px; cursor: pointer;">üîÑ</button>
        </div>
        <div id="reception-summary" style="margin-top:10px;margin-bottom:10px;color:#e0e0e0;"></div>
        <div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;">
            <div style="flex:1;min-width:400px;">
                <h3 style="color:#e0e0e0;">Reception Range by Bearing (All Altitudes)</h3>
                <canvas id="reception-bearing-canvas" width="400" height="400" style="border:1px solid #555;background:#1e1e1e;"></canvas>
            </div>
            <div style="flex:1;min-width:400px;">
                <h3 style="color:#e0e0e0;">Reception Range by Altitude (All Bearings)</h3>
                <canvas id="reception-altitude-canvas" width="400" height="400" style="border:1px solid #555;background:#1e1e1e;"></canvas>
            </div>
        </div>
        <div style="margin-bottom:20px;">
            <h3 style="color:#e0e0e0;">3D Reception Range (Bearing √ó Altitude √ó Range)</h3>
            <div id="reception-3d-plot" style="width:100%;height:500px;border:1px solid #555;background:#1e1e1e;"></div>
        </div>
        <!-- Use an explicit, pinned Plotly version to avoid deprecation warnings when using plotly-latest -->
        <script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>
    </div>

    <div id="live-tab" class="tab-content active">
        <h2>Live Statistics</h2>
        <div id="live-stats">
            <div>Tracking: <span id="tracking-count">0</span></div>
            <div>Positions Used: <span id="position-total">0</span></div>
            <div>Server Uptime: <span id="runtime">0:00</span></div>
            <div>Receivers: <span id="receiver-count">0</span></div>
            <div>Max RSSI: <span id="max-rssi">N/A</span></div>
            <div>Min RSSI: <span id="min-rssi">N/A</span></div>
            <div>Max Range: <span id="max-range">N/A</span> nm</div>
            <div>Min Range: <span id="min-range">N/A</span> nm</div>
        </div>
        <h2>Live Aircraft</h2>
        <table id="aircraft-table" class="sortable">
            <thead>
                <tr>
                    <th data-sort="icao">ICAO</th>
                    <th data-sort="flight">Flight</th>
                    <th data-sort="airline">Airline</th>
                    <th>Airline Logo</th>
                    <th data-sort="reg">Reg</th>
                        <th data-sort="type">Type</th>
                        <th data-sort="manufacturer">Manufacturer</th>
                        <th>Manufacturer Logo</th>
                        <th data-sort="bodytype">Body Type</th>
                    <th data-sort="squawk">Squawk</th>
                    <th data-sort="alt" data-sort-numeric="true">Altitude (ft)</th>
                    <th data-sort="speed" data-sort-numeric="true">Speed (kt)</th>
                    <th data-sort="vert_rate" data-sort-numeric="true">Vert Rate (ft/min)</th>
                    <th data-sort="lat" data-sort-numeric="true">Lat</th>
                    <th data-sort="lon" data-sort-numeric="true">Lon</th>
                    <th data-sort="messages" data-sort-numeric="true">Messages</th>
                    <th data-sort="rssi" data-sort-numeric="true">RSSI</th>
                    <th data-sort="slant_start" data-sort-numeric="true">Slant Range (nm)</th>
                </tr>
            </thead>
            <tbody id="aircraft-table-body"></tbody>
        </table>
    </div>

    <div id="airlines-tab" class="tab-content">
        <h2>Airline Statistics</h2>
        <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <!-- Per-tab quick buttons removed: global time control is used instead -->
            <!-- Start/End now in global header -->
            
        </div>
        <div id="airline-stats-summary-last-hour"></div>

        <div id="airline-flights-drilldown" style="display: none; margin-top: 30px; padding: 20px; background: #1e1e1e; border-radius: 8px; border: 2px solid #42a5f5;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="airline-flights-title" style="color: #42a5f5; margin: 0;">Flights</h3>
                <button onclick="closeAirlineFlightsDrilldown()" style="padding: 5px 15px; background: #666; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
            <div id="airline-flights-summary" style="margin-bottom: 15px; color: #e0e0e0;"></div>
            <table id="airline-flights-table" class="sortable" style="width: 100%;">
                <thead>
                    <tr style="background: #2a2a2a; color: #e0e0e0;">
                        <th data-sort="callsign">Flight</th>
                        <th data-sort="airline-code">ICAO Code</th>
                        <th data-sort="registration">Registration</th>
                            <th data-sort="type">Type</th>
                            <th data-sort="manufacturer">Manufacturer</th>
                            <th>Manufacturer Logo</th>
                            <th data-sort="bodytype">Body Type</th>
                        <th data-sort="start_time" data-sort-numeric="true">Start</th>
                        <th data-sort="end_time" data-sort-numeric="true">End</th>
                        <th data-sort="duration" data-sort-numeric="true">Duration</th>
                        <th data-sort="status">Status</th>
                    </tr>
                </thead>
                <tbody id="airline-flights-table-body"></tbody>
            </table>
        </div>

        <table id="airline-stats-table-last-hour" class="sortable">
            <thead>
                <tr>
                    <th data-sort="code">Code</th>
                    <th>Logo</th>
                    <th data-sort="airline">Airline</th>
                    <th data-sort="flights" data-sort-numeric="true">Flights</th>
                    <th data-sort="aircraft" data-sort-numeric="true">Unique Aircraft</th>
                    <th data-sort="lastSeen" data-sort-numeric="true">Last Seen</th>
                    <th data-sort="topManufacturer">Manufacturers</th>
                    <th>Top Manufacturer Logo</th>
                </tr>
            </thead>
            <tbody id="airline-stats-table-body-last-hour"></tbody>
        </table>
        
        
    </div>

    <div id="positions-tab" class="tab-content">
        <h2>Position Statistics</h2>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <!-- Per-tab quick buttons removed: use the global time control in the header -->
            <!-- Start/End now in global header -->
            <button class="auto-hidden-refresh" onclick="loadUnifiedPositionStats()" title="Refresh" style="padding: 6px 15px; background: #42a5f5; color: #fff; border: none; border-radius: 4px; cursor: pointer;">üîÑ</button>
        </div>
        <div style="margin-bottom: 20px; color:#bdbdbd">Using timescale: <span id="positions-timescale-indicator">24h</span></div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <!-- Memory Stats Card -->
            <div onclick="switchPositionDataSource('memory')" style="padding: 20px; background: #1e1e1e; border-radius: 8px; border: 2px solid #4caf50; cursor: pointer; transition: all 0.3s ease;">
                <h3 style="margin: 0 0 15px 0; color: #4caf50; font-size: 18px;">üìä Live Memory</h3>
                <div id="memory-stats" style="color: #e0e0e0; font-size: 14px; line-height: 1.8;">
                    <div><strong>Positions:</strong> <span id="memory-positions">-</span></div>
                    <div><strong>Aircraft:</strong> <span id="memory-aircraft">-</span></div>
                    <div><strong>Flights:</strong> <span id="memory-flights">-</span></div>
                    <div><strong>Airlines:</strong> <span id="memory-airlines">-</span></div>
                </div>
            </div>
            
            <!-- Cache Stats Card -->
            <div onclick="switchPositionDataSource('cache')" style="padding: 20px; background: #1e1e1e; border-radius: 8px; border: 2px solid #2196f3; cursor: pointer; transition: all 0.3s ease;">
                <h3 style="margin: 0 0 15px 0; color: #2196f3; font-size: 18px;">üíæ Cache</h3>
                <div id="cache-stats" style="color: #e0e0e0; font-size: 14px; line-height: 1.8;">
                    <div><strong>Positions:</strong> <span id="cache-positions">-</span></div>
                    <div><strong>Aircraft:</strong> <span id="cache-aircraft">-</span></div>
                    <div><strong>Flights:</strong> <span id="cache-flights">-</span></div>
                    <div><strong>Airlines:</strong> <span id="cache-airlines">-</span></div>
                </div>
            </div>
            
            <!-- S3 Buckets Stats Card -->
            <div onclick="switchPositionDataSource('s3')" style="padding: 20px; background: #1e1e1e; border-radius: 8px; border: 2px solid #ff9800; cursor: pointer; transition: all 0.3s ease;">
                <h3 style="margin: 0 0 15px 0; color: #ff9800; font-size: 18px;">‚òÅÔ∏è S3 Buckets</h3>
                <div id="bucket-stats" style="color: #e0e0e0; font-size: 14px; line-height: 1.8;">
                    <div><strong>Positions:</strong> <span id="bucket-positions">-</span></div>
                    <div><strong>Aircraft:</strong> <span id="bucket-aircraft">-</span></div>
                    <div><strong>Flights:</strong> <span id="bucket-flights">-</span></div>
                    <div><strong>Airlines:</strong> <span id="bucket-airlines">-</span></div>
                </div>
            </div>
        </div>
        
        <h3 style="color: #e0e0e0; margin-top: 30px; margin-bottom: 15px;">Time Series Graph</h3>
        <div style="margin-bottom: 15px;">
            <label style="color: #e0e0e0; margin-right: 15px;"><input type="checkbox" id="graph-positions" checked onchange="drawPositionsTimeSeriesGraph(positionDataSources[positionDataSources.active])"> Positions</label>
            <label style="color: #e0e0e0; margin-right: 15px;"><input type="checkbox" id="graph-aircraft" checked onchange="drawPositionsTimeSeriesGraph(positionDataSources[positionDataSources.active])"> Aircraft</label>
            <label style="color: #e0e0e0; margin-right: 15px;"><input type="checkbox" id="graph-flights" checked onchange="drawPositionsTimeSeriesGraph(positionDataSources[positionDataSources.active])"> Flights</label>
            <label style="color: #e0e0e0;"><input type="checkbox" id="graph-airlines" checked onchange="drawPositionsTimeSeriesGraph(positionDataSources[positionDataSources.active])"> Airlines</label>
        </div>
        <canvas id="positions-timeseries-canvas" width="1200" height="400" style="border: 1px solid #555; background: #1e1e1e;"></canvas>
    </div>

    <div id="flights-tab" class="tab-content">
        <div style="margin-bottom: 12px;">
            <label style="font-weight: bold; color: #e0e0e0;">Gap minutes: <input id="flights-gap" type="number" value="5" min="1" style="width:60px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; padding: 5px;"></label>
        </div>
        <h2 id="flights-main-title">Flights</h2>
        <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <!-- Per-tab quick buttons removed: use the global time control in the header -->
            <!-- Start/End now in global header -->
            <!-- Refresh handled automatically on custom range exit or quick button press -->
        </div>
        <div id="flights-summary" style="margin-top:15px;padding:12px;background:#1e1e1e;border-radius:4px;border-left:4px solid #42a5f5;font-weight:bold;font-size:16px;color:#e0e0e0;"></div>
        <table id="flights-table" class="sortable">
            <thead>
                <tr>
                    <th data-sort="icao">ICAO</th>
                    <th data-sort="callsign">Callsign</th>
                    <th data-sort="airline_code">Airline Code</th>
                    <th data-sort="airline">Airline</th>
                    <th>Airline Logo</th>
                    <th data-sort="reg">Reg</th>
                    <th data-sort="type">Type</th>
                    <th data-sort="manufacturer">Manufacturer</th>
                    <th>Manufacturer Logo</th>
                    <th data-sort="bodytype">Body Type</th>
                    <th data-sort="start_time">Start Time</th>
                    <th data-sort="end_time">End Time</th>
                    <th data-sort="duration" data-sort-numeric="true">Duration (min)</th>
                    <th data-sort="start_lat" data-sort-numeric="true">Start Lat</th>
                    <th data-sort="start_lon" data-sort-numeric="true">Start Lon</th>
                    <th data-sort="end_lat" data-sort-numeric="true">End Lat</th>
                    <th data-sort="end_lon" data-sort-numeric="true">End Lon</th>
                    <th data-sort="max_alt" data-sort-numeric="true">Max Alt</th>
                    <th data-sort="reports" data-sort-numeric="true">Reports</th>
                    <th data-sort="slant_start" data-sort-numeric="true">Slant Range Start (nm)</th>
                    <th data-sort="slant_end" data-sort-numeric="true">Slant Range End (nm)</th>
                </tr>
            </thead>
            <tbody id="flights-table-body"></tbody>
        </table>
    </div>

    <div id="squawk-tab" class="tab-content">
        <h2>Squawk Code Transition Analysis</h2>
        <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <!-- Per-tab quick buttons removed: use the global time control in the header -->
            <!-- Start/End now in global header -->
            <button class="auto-hidden-refresh" onclick="loadSquawkTransitions()" title="Refresh" style="padding: 6px 15px; background: #42a5f5; color: #fff; border: none; border-radius: 4px; cursor: pointer;">üîÑ</button>
        </div>
        <div id="squawk-summary"></div>
        <h3 style="color: #4caf50; border-bottom: 2px solid #66bb6a; padding-bottom: 8px; margin-top: 20px;">VFR (1200)</h3>
        <ul id="vfr-transitions" style="list-style: none; padding: 0;"></ul>
        <h3 style="color: #2196f3; border-bottom: 2px solid #42a5f5; padding-bottom: 8px; margin-top: 20px;">IFR LOW (0000-1777)</h3>
        <ul id="ifr-low-transitions" style="list-style: none; padding: 0;"></ul>
        <h3 style="color: #1976d2; border-bottom: 2px solid #1e88e5; padding-bottom: 8px; margin-top: 20px;">IFR HIGH (2000-7777)</h3>
        <ul id="ifr-high-transitions" style="list-style: none; padding: 0;"></ul>
        <h3 style="color: #f44336; border-bottom: 2px solid #e53935; padding-bottom: 8px; margin-top: 20px;">SPECIAL (7500/7600/7700)</h3>
        <ul id="special-transitions" style="list-style: none; padding: 0;"></ul>
        <h3 style="color: #9e9e9e; border-bottom: 2px solid #bdbdbd; padding-bottom: 8px; margin-top: 20px;">OTHER</h3>
        <ul id="other-transitions" style="list-style: none; padding: 0;"></ul>
    </div>

    <div id="heatmap-tab" class="tab-content">
        <h2>Aircraft Position Heatmap</h2>

        <div style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; border: 1px solid #333;">
            <h3 style="color: #0066cc; margin-top: 0;">üó∫Ô∏è Leaflet Heatmap Viewer</h3>
            <a id="leaflet-heatmap-link" href="/heatmap-leaflet" target="_blank" style="display: inline-block; padding: 8px 16px; background: #0066cc; color: white; border-radius: 4px; text-decoration: none; font-weight: 500;">Open Leaflet Heatmap Viewer ‚Üí</a>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <h3 style="color: #ff9800; margin-top: 0;">‚öôÔ∏è Heatmap Configuration</h3>
            
            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center; margin-bottom: 15px;">
                <div style="display: flex; flex-direction: column;">
                    <label for="heatmap-source" style="color: #e0e0e0; font-weight: 600; margin-bottom: 5px;">Data Source:</label>
                    <select id="heatmap-source" style="background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; padding: 8px; min-width: 120px;">
                        <option value="memory">Memory (Live)</option>
                        <option value="tsdb" selected>TSDB (Historical)</option>
                    </select>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="heatmap-hours" style="color: #e0e0e0; font-weight: 600; margin-bottom: 5px;">Time Window:</label>
                    <select id="heatmap-hours" style="background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; padding: 8px; min-width: 120px;">
                        <option value="1">1 Hour</option>
                        <option value="4">4 Hours</option>
                        <option value="6">6 Hours</option>
                        <option value="12">12 Hours</option>
                        <option value="24" selected>24 Hours</option>
                        <option value="48">48 Hours</option>
                        <option value="168">1 Week</option>
                    </select>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="heatmap-grid-size" style="color: #e0e0e0; font-weight: 600; margin-bottom: 5px;">Grid Size (NM):</label>
                    <select id="heatmap-grid-size" style="background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; padding: 8px; min-width: 120px;">
                        <option value="0.5">0.5 NM</option>
                        <option value="1" selected>1 NM</option>
                        <option value="2">2 NM</option>
                        <option value="5">5 NM</option>
                        <option value="10">10 NM</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="test-heatmap-config" onclick="testHeatmapConfiguration()" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">üß™ Test Configuration</button>
                <button onclick="resetHeatmapConfig()" style="padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Reset</button>
            </div>
            
            <div id="heatmap-config-result" style="margin-top: 15px; padding: 10px; background: #2a2a2a; border-radius: 4px; color: #e0e0e0; font-family: monospace; display: none;"></div>
        </div>
    </div>

    <div id="cache-tab" class="tab-content">
        <h2>Cache Status</h2>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <h3 style="color: #4caf50; margin-top: 0;">üìä Heatmap Cache Statistics</h3>
            <button class="auto-hidden-refresh" onclick="loadCacheStatus()" title="Refresh Cache Status" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">üîÑ</button>
            <button onclick="clearHeatmapCache()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">üóëÔ∏è Clear Heatmap Cache</button>
            <button onclick="clearAirlineDBCache()" style="padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">üóëÔ∏è Clear Airline DB Cache</button>
            
            <div id="cache-status" style="color: #e0e0e0; font-family: monospace; background: #2a2a2a; padding: 15px; border-radius: 4px; margin-top: 10px;">
                <div>Loading cache status...</div>
            </div>
            <div id="cache-summary" style="margin-top:10px;color:#e0e0e0;"></div>
        </div>
        
        <div style="padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <h3 style="color: #2196f3; margin-top: 0;">üíæ Cache Information</h3>
            <div style="color: #e0e0e0; line-height: 1.6;">
                <p>The heatmap cache stores aircraft position data in memory for faster loading of heatmap visualizations.</p>
                <p><strong>Cache Contents:</strong> Aircraft positions with timestamps, aircraft types, manufacturers, and flight information.</p>
                <p><strong>Cache Source:</strong> S3 bucket data (piaware_aircraft_log files)</p>
                <p><strong>Cache Refresh:</strong> Automatically reloaded when cleared or when server restarts</p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="app.js"></script>
    <style>
    /* Hide refresh buttons by default; script will unhide ones with handlers */
    .auto-hidden-refresh { display: none !important; }
    </style>
    <script>
    // Hide refresh buttons early, then unhide those that have handlers after app.js runs.
    (function() {
        try {
            const allBtns = Array.from(document.querySelectorAll('button'));
            const refreshBtns = allBtns.filter(b => /üîÑ|Refresh/i.test(b.innerText || b.textContent || ''));
            refreshBtns.forEach(b => b.classList.add('auto-hidden-refresh'));
        } catch (e) {}
    })();

    // After other scripts load, unhide buttons that actually have handlers.
    window.addEventListener('load', function() {
        try {
            const buttons = Array.from(document.querySelectorAll('button.auto-hidden-refresh'));
            buttons.forEach(btn => {
                const hasInline = btn.getAttribute('onclick') != null || typeof btn.onclick === 'function';
                let hasListeners = false;
                if (typeof window.getEventListeners === 'function') {
                    try {
                        const ev = getEventListeners(btn);
                        if (ev && ev.click && ev.click.length > 0) hasListeners = true;
                    } catch (e) {}
                }
                if (!hasListeners && btn.dataset && (btn.dataset.listener || btn.dataset.attached)) hasListeners = true;
                if (hasInline || hasListeners) {
                    btn.classList.remove('auto-hidden-refresh');
                }
            });
            // Force-hide any refresh buttons inside the Airlines tab specifically
            try {
                const airlinesRefreshBtns = Array.from(document.querySelectorAll('#airlines-tab button'))
                    .filter(b => /üîÑ|Refresh/i.test(b.innerText || b.textContent || ''));
                airlinesRefreshBtns.forEach(b => b.classList.add('auto-hidden-refresh'));
            } catch (e) {}
        } catch (e) {
            console.warn('Refresh button visibility adjustment failed', e);
        }
    });
    </script>
</body>
</html>
